<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aws-sdk/2.1298.0/aws-sdk.min.js"></script>
  </head>
  <body>
    <h1>My Photo Albums App</h1>
    <div id="app"></div>
    <script>
      var albumBucketName = "eruty";
      var bucketRegion = "ap-northeast-2";
      var IdentityPoolId =
        "ap-northeast-2:ad9e4563-487d-40f1-9394-4710693f7fab";

      AWS.config.update({
        region: bucketRegion,
        credentials: new AWS.CognitoIdentityCredentials({
          IdentityPoolId: IdentityPoolId,
        }),
      });

      var s3 = new AWS.S3({
        apiVersion: "2006-03-01",
        params: { Bucket: albumBucketName },
      });

      function listAlbums() {
        s3.listObjects({ Delimiter: "/" }, function (err, data) {
          if (err) {
            return alert(
              "There was an error listing your albums: " + err.message
            );
          } else {
            var albums = data.CommonPrefixes.map(function (commonPrefix) {
              var prefix = commonPrefix.Prefix;
              var albumName = decodeURIComponent(prefix.replace("/", ""));
              return getHtml([
                "<li>",
                "<span onclick=\"deleteAlbum('" + albumName + "')\">X</span>",
                "<span onclick=\"viewAlbum('" + albumName + "')\">",
                albumName,
                "</span>",
                "</li>",
              ]);
            });
            var message = albums.length
              ? getHtml([
                  "<p>Click on an album name to view it.</p>",
                  "<p>Click on the X to delete the album.</p>",
                ])
              : "<p>You do not have any albums. Please Create album.";
            var htmlTemplate = [
              "<h2>Albums</h2>",
              message,
              "<ul>",
              getHtml(albums),
              "</ul>",
              "<button onclick=\"createAlbum(prompt('Enter Album Name:'))\">",
              "Create New Album",
              "</button>",
            ];
            document.getElementById("app").innerHTML = getHtml(htmlTemplate);
          }
        });
      }

      
      function viewAlbum(albumName) {
        var albumPhotosKey = encodeURIComponent(albumName) + "/";
        s3.listObjects({ Prefix: albumPhotosKey }, function (err, data) {
          if (err) {
            return alert(
              "There was an error viewing your album: " + err.message
            );
          }
          // 'this' references the AWS.Response instance that represents the response
          var href = this.request.httpRequest.endpoint.href;
          var bucketUrl = href + albumBucketName + "/";

          var photos = data.Contents.map(function (photo) {
            var photoKey = photo.Key;
            var photoUrl = bucketUrl + encodeURIComponent(photoKey);
            return getHtml([
              "<span>",
              "<div>",
              '<img style="width:128px;height:128px;" src="' + photoUrl + '"/>',
              "</div>",
              "<div>",
              "<span onclick=\"deletePhoto('" +
                albumName +
                "','" +
                photoKey +
                "')\">",
              "X",
              "</span>",
              "<span>",
              photoKey.replace(albumPhotosKey, ""),
              "</span>",
              "</div>",
              "</span>",
            ]);
          });
          var message = photos.length
            ? "<p>Click on the X to delete the photo</p>"
            : "<p>You do not have any photos in this album. Please add photos.</p>";
          var htmlTemplate = [
            "<h2>",
            "Album: " + albumName,
            "</h2>",
            message,
            "<div>",
            getHtml(photos),
            "</div>",
            '<input id="photoupload" type="file" accept="image/*">',
            '<button id="addphoto" onclick="addPhoto(\'' + albumName + "')\">",
            "Add Photo",
            "</button>",
            '<button onclick="listAlbums()">',
            "Back To Albums",
            "</button>",
          ];
          document.getElementById("app").innerHTML = getHtml(htmlTemplate);
        });
      }

      function addPhoto(albumName) {
        var files = document.getElementById("photoupload").files;
        if (!files.length) {
          return alert("Please choose a file to upload first.");
        }
        var file = files[0];
        var fileName = file.name;
        var albumPhotosKey = encodeURIComponent(albumName) + "/";

        var photoKey = albumPhotosKey + fileName;

        // Use S3 ManagedUpload class as it supports multipart uploads
        var upload = new AWS.S3.ManagedUpload({
          params: {
            Bucket: albumBucketName,
            Key: photoKey,
            Body: file,
          },
        });

        var promise = upload.promise();

        promise.then(
          function (data) {
            alert("Successfully uploaded photo.");
            viewAlbum(albumName);
          },
          function (err) {
            return alert(
              "There was an error uploading your photo: ",
              err.message
            );
          }
        );
      }

      
      function getHtml(template) {
        return template.join("\n");
      }
      listAlbums();
    </script>
    </script>
  </body>
</html>
